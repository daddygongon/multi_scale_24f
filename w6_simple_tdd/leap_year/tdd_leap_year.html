<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="jp" xml:lang="jp">
<head>
<!-- 2024-10-21 Mon 09:57 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>third lesson for ruby novice &#x2013; test --</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Shigeto R. Nishitani" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="src/readtheorg_theme/css/search.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/search.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">third lesson for ruby novice &#x2013; test --</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge85cd5b">1. 初めからframe work?</a></li>
<li><a href="#org36b6474">2. テスト駆動の実際</a>
<ul>
<li><a href="#org5f6d4f2">2.1. お題はうるう年</a></li>
<li><a href="#org5d4034c">2.2. 2004年はleap year</a></li>
<li><a href="#orgdbc8b63">2.3. 1999はfalse</a></li>
<li><a href="#orgb8fbca7">2.4. テストの自動化</a></li>
<li><a href="#org908c448">2.5. 1900はtrue? いえいえfalse</a></li>
<li><a href="#orgd0a01fc">2.6. refactoring 条件式の単純化</a></li>
<li><a href="#org512a568">2.7. そして2000はtrue！</a></li>
</ul>
</li>
<li><a href="#org63bcbb5">3. refactoring:methodに</a></li>
<li><a href="#org0bfc39d">4. caseで</a></li>
<li><a href="#orgb3c99ab">5. とやり過ぎ</a></li>
<li><a href="#org374eb73">6. もっとすごいtdd</a></li>
<li><a href="#org5251020">7. テストをmain loopに書くこと</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge85cd5b" class="outline-2">
<h2 id="orge85cd5b"><span class="section-number-2">1</span> 初めからframe work?</h2>
<div class="outline-text-2" id="text-1">
<p>
テストの重要性はある程度認識していると思います.
ただ，巷にあるテキストはTDDのためのframe workを使いなさいとなっていて面倒そうです．
でも本当は，テスト駆動でのcodingは，とっても簡単で便利というのを見てもらいましょう．
</p>
</div>
</div>

<div id="outline-container-org36b6474" class="outline-2">
<h2 id="org36b6474"><span class="section-number-2">2</span> テスト駆動の実際</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org5f6d4f2" class="outline-3">
<h3 id="org5f6d4f2"><span class="section-number-3">2.1</span> お題はうるう年</h3>
<div class="outline-text-3" id="text-2-1">
<p>
うるう年の課題ってやったことありますよね．
</p>

<pre class="example">
うるう年(leap year)かどうかを表示するプログラムをかけ．
1. うるう年は4で割り切れる数の年．ただし，
2. 100で割り切れる年はうるう年でなく，
3. 400で割り切れる年はうるう年．
4. 2004, 1999, 1900, 2000で試せ．
5. それぞれtrue, false, false, true
</pre>
<p>
この条件分岐をあらかじめ考えて実装するのってきつくなかったですか？
そいつを順を追って見てもらいましょう．
</p>
</div>
</div>
<div id="outline-container-org5d4034c" class="outline-3">
<h3 id="org5d4034c"><span class="section-number-3">2.2</span> 2004年はleap year</h3>
<div class="outline-text-3" id="text-2-2">
<p>
まず4,5は振る舞いを記述する仕様(specification, spec)ではないですよね．例えば，
</p>
<pre class="example">
ruby check_leap_year.rb 2004
</pre>

<p>
とした時に
</p>
<pre class="example">
true
</pre>

<p>
と返ってきてほしいというテストの仕様です．
</p>

<p>
2004年の振る舞いだけを実装すると，
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #483d8b;">p</span> year = <span style="color: #228b22;">ARGV</span>[0].to_i
<span style="color: #a020f0;">if</span> year % 4 == 0
  <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>

<p>
です．これをtestすると
</p>
<pre class="example">
&gt; ruby check_leap_0.rb 2004
2004
true
</pre>
<p>
となります．
</p>
</div>
</div>

<div id="outline-container-orgdbc8b63" class="outline-3">
<h3 id="orgdbc8b63"><span class="section-number-3">2.3</span> 1999はfalse</h3>
<div class="outline-text-3" id="text-2-3">
<p>
次に1999をtestすると
</p>
<pre class="example">
&gt; ruby check_leap_0.rb 1999
1999
</pre>
<p>
です．これをfalseと返すようにすると，
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #483d8b;">p</span> year = <span style="color: #228b22;">ARGV</span>[0].to_i
<span style="color: #a020f0;">if</span> year%4 == 0
  <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
<span style="color: #a020f0;">else</span>
  <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>

<p>
ちゃんと返ってます？
</p>
</div>
</div>

<div id="outline-container-orgb8fbca7" class="outline-3">
<h3 id="orgb8fbca7"><span class="section-number-3">2.4</span> テストの自動化</h3>
<div class="outline-text-3" id="text-2-4">
<p>
この後，さらにテストの内容が増えてくると，
いちいち引数(ARGV[0])で全てチェックするのが面倒になってきそうでしょ．
lazy programmerは二つ以上は耐えられません．
そこで，テストの自動化をします．
</p>

<p>
なに，配列にしてloopで回すだけです．
</p>
<div class="org-src-container">
<pre class="src src-ruby">[2004, 1999].each <span style="color: #a020f0;">do</span> |year|
  <span style="color: #483d8b;">p</span> year
  <span style="color: #a020f0;">if</span> year%4 == 0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org908c448" class="outline-3">
<h3 id="org908c448"><span class="section-number-3">2.5</span> 1900はtrue? いえいえfalse</h3>
<div class="outline-text-3" id="text-2-5">
<p>
では次の
</p>
<pre class="example">
100で割り切れる年はうるう年でなく，
</pre>

<p>
ですが，1900はtrueが返って来るのをfalseが返るように変更します．
</p>

<p>
まずはテストの修正
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1900, 2004, 1999].each <span style="color: #a020f0;">do</span> |year|
</pre>
</div>

<p>
次に100で割り切れる場合の処理です．
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">if</span> year%100 == 0
  <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
何ですが，これをどこに入れるかで悩んでしまいます．
とりあえず別処理として前に付け加えておくと，
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1900,2004,1999].each <span style="color: #a020f0;">do</span> |year|
  <span style="color: #483d8b;">p</span> year
  <span style="color: #a020f0;">if</span> year % 100 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
    <span style="color: #a020f0;">next</span>
  <span style="color: #a020f0;">end</span>
  <span style="color: #a020f0;">if</span> year % 4 == 0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
そしてtestです．
</p>
<pre class="example">
bash-3.2$ ruby check_leap_year_19_0.rb 
1900
false
2004
true
1999
false
</pre>
<p>
うまいこと動いていますよね．
</p>
</div>
</div>
<div id="outline-container-orgd0a01fc" class="outline-3">
<h3 id="orgd0a01fc"><span class="section-number-3">2.6</span> refactoring 条件式の単純化</h3>
<div class="outline-text-3" id="text-2-6">
<p>
先ほどの条件式は二つに完全に分けています．
でも，論理的にネスト(入れ子)にする方がいい場合もあります．
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1900,2004,1999].each <span style="color: #a020f0;">do</span> |year|
  <span style="color: #483d8b;">p</span> year
  <span style="color: #a020f0;">if</span> year % 100 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #a020f0;">if</span> year % 4 == 0
      <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
    <span style="color: #a020f0;">else</span>
      <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
    <span style="color: #a020f0;">end</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
ですが，ここまでするとif 100 else .. endのelseを省略できることがわかるでしょ．
そうすると，
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1900,2004,1999].each <span style="color: #a020f0;">do</span> |year|
  <span style="color: #483d8b;">p</span> year
  <span style="color: #a020f0;">if</span> year % 100 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">elsif</span> year % 4 == 0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
となります．
</p>
</div>
</div>
<div id="outline-container-org512a568" class="outline-3">
<h3 id="org512a568"><span class="section-number-3">2.7</span> そして2000はtrue！</h3>
<div class="outline-text-3" id="text-2-7">
<p>
最後の
</p>
<pre class="example">
3. 400で割り切れる年はうるう年．
</pre>

<p>
です．2000年はtrue?
</p>
</div>
</div>
</div>

<div id="outline-container-org63bcbb5" class="outline-2">
<h2 id="org63bcbb5"><span class="section-number-2">3</span> refactoring:methodに</h2>
<div class="outline-text-2" id="text-3">
<p>
次はmethodにしたくなりますよね．関数の名前はleap?
としましょう．
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">leap?</span>(year)
  <span style="color: #a020f0;">if</span> year % 400 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">elsif</span> year % 100 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">elsif</span> year % 4 == 0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span> 
<span style="color: #a020f0;">end</span>
[2000, 1900, 2004, 1999].each <span style="color: #a020f0;">do</span> |year|
  <span style="color: #483d8b;">p</span> year
  leap?(year)
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
です．true falseを返して，main loopでpする方がいいです．
</p>
</div>
</div>

<div id="outline-container-org0bfc39d" class="outline-2">
<h2 id="org0bfc39d"><span class="section-number-2">4</span> caseで</h2>
<div class="outline-text-2" id="text-4">
<p>
ここまででも十分に綺麗なのですが，もっと綺麗にかけます．
caseを使います．
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">leap?</span>(year)
  <span style="color: #a020f0;">case</span> year
  <span style="color: #a020f0;">when</span> % 400 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">when</span> % 100 ==0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">when</span> % 4 == 0
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
when以降には論理値があればいいので，こういう書き方ができます．
嘘です．動きません．
こんななります．
</p>
<pre class="example">
&gt; ruby check_leap_year_19_case_wrong.rb 
2000
false
1900
false
2004
false
1999
false
</pre>
</div>
</div>
<div id="outline-container-orgb3c99ab" class="outline-2">
<h2 id="orgb3c99ab"><span class="section-number-2">5</span> とやり過ぎ</h2>
<div class="outline-text-2" id="text-5">
<p>
調子こきました．間違いです．ごめんなさい．
ちゃんと結果見てませんでした．だからgreenが必要です．
これは次のとこで．
</p>

<p>
ちゃんと動くのは，
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">leap?</span>(year)
  <span style="color: #a020f0;">case</span>
  <span style="color: #a020f0;">when</span> year % 400 ==0 ; <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">when</span> year % 100 ==0 ; <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">when</span> year % 4 ==0 ;   <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span> ;                 <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
でした．
</p>

<p>
どっかでこういうのを見たことがあるもんやから，
うまくいったと思ってました．ごめんなさい．
</p>
</div>
</div>

<div id="outline-container-org374eb73" class="outline-2">
<h2 id="org374eb73"><span class="section-number-2">6</span> もっとすごいtdd</h2>
<div class="outline-text-2" id="text-6">
<p>
上の知識があると全く逆からのtddも可能です．
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">leap?</span>(year)
  <span style="color: #a020f0;">case</span> 
  <span style="color: #a020f0;">when</span> year == 2000 ; <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">when</span> year == 1900 ; <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">when</span> year == 2004 ; <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">true</span>
  <span style="color: #a020f0;">else</span>              ; <span style="color: #483d8b;">p</span> <span style="color: #008b8b;">false</span>
  <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
ですよね．この後，より一般化して，
</p>
<pre class="example">
2000 -&gt; % 400 == 0
</pre>

<p>
とかにしても問題ありません．
</p>

<p>
さらに，
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">leap?</span>(year)
  <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">case</span>
         <span style="color: #a020f0;">when</span> year % 400 ==0 ; <span style="color: #008b8b;">true</span>
         <span style="color: #a020f0;">when</span> year % 100 ==0 ; <span style="color: #008b8b;">false</span>
         <span style="color: #a020f0;">when</span> year % 4 ==0   ; <span style="color: #008b8b;">true</span>
         <span style="color: #a020f0;">else</span>                ; <span style="color: #008b8b;">false</span>
         <span style="color: #a020f0;">end</span>
<span style="color: #a020f0;">end</span>
</pre>
</div>
<p>
とするといいかも．これは確認済み．
</p>
</div>
</div>

<div id="outline-container-org5251020" class="outline-2">
<h2 id="org5251020"><span class="section-number-2">7</span> テストをmain loopに書くこと</h2>
<div class="outline-text-2" id="text-7">
<p>
こういう風に，main loopにテストを書くのは正しいのでしょうか？
大学の課題ならいざ知らず，会社でこんなことしていいんでしょうか？
</p>

<p>
いいんですよ．
</p>

<p>
昔は推奨されていたぐらいですから．
leap?関数がどのような振る舞いをするべきかを仕様(spec)として書いておくと，
関数を使う人にも，関数を改良する人にも，関数を探している人にも便利ですよね．
そういう仕様は，どこにおけばいいんでしょう？
関数の置き場所にできるだけ近いところがいいと思いませんか？
なら，main loopでしょ．
</p>

<p>
TDDのバイブルのKent Beck本でもxUnitというのをmain loopに．．
あ，違うな．でも工夫しましょ．
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Shigeto R. Nishitani</p>
<p class="date">Created: 2024-10-21 Mon 09:57</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
